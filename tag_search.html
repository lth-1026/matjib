<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>키워드 매물 검색</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      background: #f7eee4;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .wrap {
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    h1 {
      margin-top: 0;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #d3a576;
      color: #fff;
      font-size: 12px;
      margin-left: 8px;
    }

    a {
      color: #875c44;
      text-decoration: none;
      font-size: 14px;
    }

    a:hover {
      text-decoration: underline;
    }

    .region-box {
      margin-top: 16px;
      padding: 12px 14px;
      background: #faf4ea;
      border-radius: 10px;
      font-size: 14px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #875c44;
      color: #fff;
      font-size: 11px;
      margin-left: 6px;
    }

    /* Card Layout */
    .card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }

    .house-card {
      width: 250px;
      background: #fdf7f0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }

    .house-card .card-photo {
      height: 140px;
      background: #ddd;
      background-size: cover;
      background-position: center;
    }

    .house-card .card-body {
      padding: 10px 12px 12px;
    }

    .card-region {
      font-size: 13px;
      color: #777;
      margin-bottom: 4px;
    }

    .card-price-main {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
      color: #333;
    }

    .card-meta {
      font-size: 13px;
      color: #555;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <a href="index.html">&larr; 맺집으로 돌아가기</a>

    <h1 id="pageTitle">
      키워드: <span id="tagLabel"></span>
      <span class="badge" id="countBadge">0개 매물</span>
    </h1>

    <div class="region-box" id="regionBox">
      <strong><span id="tagLabel2"></span> 매물이 많은 지역 TOP 3</strong>
      <ol id="topRegionsList" style="margin: 6px 0 0 20px; padding: 0;">
        <!-- JS populated -->
      </ol>
      <p id="noDataMsg" style="display:none; margin:6px 0 0;">해당 키워드를 가진 매물이 아직 없습니다.</p>
    </div>

    <h2 style="margin-top: 24px; font-size:18px;">매물 목록</h2>

    <div id="houseListContainer">
      <p id="listEmptyMsg" style="display:none;">이 키워드를 포함하는 매물이 없습니다.</p>
      <div class="card-grid" id="cardGrid">
        <!-- JS populated -->
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://matjib-ai.th20001026.workers.dev";

    const tagNames = {
      'walk': '산책',
      'running': '러닝',
      'pet': '반려동물',
      'gym': '헬스',
      'concert': '콘서트',
      'cafe': '카페',
      'hiking': '등산',
      'baseball': '야구'
    };

    let regionMap = {};

    function getRegionNameById(id) {
      return regionMap[id] ? regionMap[id].label : "알 수 없음";
    }

    function priceLabel(h) {
      if (h.rent_type === '전세') {
        return '전세 ' + h.deposit.toLocaleString();
      } else {
        return '월세 ' + h.deposit.toLocaleString() + ' / ' + h.rent.toLocaleString();
      }
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const tag = params.get('tag');

      if (!tag || !tagNames[tag]) {
        alert("유효하지 않은 태그입니다.");
        window.location.href = "index.html";
        return;
      }

      const label = tagNames[tag];
      document.getElementById('tagLabel').textContent = label;
      document.getElementById('tagLabel2').textContent = label;
      document.title = `키워드: ${label} 매물`;

      try {
        // Load Data
        const [regionsRes, housesRes] = await Promise.all([
          fetch('regions.json'),
          fetch('houses.json')
        ]);

        const regions = await regionsRes.json();
        const housesData = await housesRes.json();

        // Build Region Map
        regions.forEach(r => {
          regionMap[r.id] = r;
        });

        // Filter Houses
        const filtered = housesData.filter(item => {
          return item.lifestyle && item.lifestyle[tag] === 1;
        });

        // Update Count
        document.getElementById('countBadge').textContent = `${filtered.length}개 매물`;

        if (filtered.length === 0) {
          document.getElementById('noDataMsg').style.display = 'block';
          document.getElementById('listEmptyMsg').style.display = 'block';
          document.getElementById('topRegionsList').style.display = 'none';
          return;
        }

        // Calculate Top 3 Regions
        const regionCounts = {};
        filtered.forEach(item => {
          const rId = item.house.address;
          const rName = getRegionNameById(rId);
          // Extract "Gu Dong" or just use region label
          // The PHP code used SUBSTRING_INDEX(address, ' ', 2).
          // Here we use the region label from regions.json which seems to be "Gu Dong" format usually.
          const regionKey = rName.split(' ').slice(0, 2).join(' ');

          regionCounts[regionKey] = (regionCounts[regionKey] || 0) + 1;
        });

        const sortedRegions = Object.entries(regionCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);

        const topList = document.getElementById('topRegionsList');
        sortedRegions.forEach(([name, count]) => {
          const li = document.createElement('li');
          li.innerHTML = `${name} <span class="pill">${count}개</span>`;
          topList.appendChild(li);
        });

        // Render List
        const grid = document.getElementById('cardGrid');
        filtered.forEach(item => {
          const h = item.house;
          const div = document.createElement('div');
          div.className = 'house-card';
          div.dataset.houseId = h.id;

          div.innerHTML = `
            <div class="card-photo"></div>
            <div class="card-body">
              <div class="card-region">${getRegionNameById(h.address)}</div>
              <div class="card-price-main">${priceLabel(h)}</div>
              <div class="card-meta">
                ${h.room_type} · ${h.area_m2}㎡
              </div>
            </div>
          `;

          div.addEventListener('click', () => {
            window.location.href = `index.html?focus=${h.id}`;
          });

          grid.appendChild(div);

          // Fetch Image
          const photoDiv = div.querySelector('.card-photo');
          fetch(`${WORKER_URL}/unsplash?id=${h.id}`)
            .then(res => res.json())
            .then(urls => {
              if (Array.isArray(urls) && urls[0]) {
                photoDiv.style.backgroundImage = `url('${urls[0]}')`;
              }
            })
            .catch(err => console.error("Image load error", err));
        });

      } catch (e) {
        console.error(e);
        alert("데이터를 불러오는데 실패했습니다.");
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>